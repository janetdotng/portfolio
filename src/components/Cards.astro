---
import Filter from '../components/Filter.astro';
import { getCollection } from 'astro:content';

const entries = await getCollection('showcase');

const cards = entries
  .sort((a, b) => {
    if (a.data.featured && !b.data.featured) return -1;
    if (!a.data.featured && b.data.featured) return 1;
    return b.data.publishDate.valueOf() - a.data.publishDate.valueOf();
  })
  .map((entry, index) => ({
    id: entry.slug,
    slug: entry.slug,
    title: entry.data.title,
    cover: entry.data.cover ?? '',
    coverAlt: entry.data.coverAlt ?? entry.data.title,
    description: entry.data.description ?? '',
    category: entry.data.category ?? [],
    tag: entry.data.tag ?? '',
    date: entry.data.publishDate.toISOString(),
    externalUrl: entry.data.externalUrl ?? null,
    index: index + 1
  }));

const count = cards.length;
---

<Filter count={count} />

<div class="section card">
  <div class="js-shuffle-sizer">
    <div class="card-list my-shuffle-container" id="js-shuffle">

      {cards.map((card) => (
        <div
          class="card-item col-xs-1a col-md-2a col-lg-3a col-xxl-4a"
          data-groups={JSON.stringify(card.category)}
          data-date-created={card.date}
          data-title={card.title}
        >
          <a
  href={card.externalUrl ? card.externalUrl : `/showcase/${card.slug}`}
  class="card-wrapper"
  target={card.externalUrl ? "_blank" : "_self"}
>
          <div class="card-header">
              <div class="card-type type">
                {card.tag && <span class="type-tag">- {card.tag} -</span>}
              </div>
              <div class="card-type type">
                <span class="type-tag">(0{card.index})</span>
              </div>
            </div>

            <div class="card-body">
              <img
  class="card-figure__img"
  src={card.cover}
  loading="lazy"
  alt={card.coverAlt}
/>
            </div>

            <div class="card-footer">
              <div class="card-detail">
                <div class="card-name card-item__title">
                  {card.title}
                </div>
                <div class="card-info">
                  {card.description}
                </div>
              </div>
            </div>

          </a>
        </div>
      ))}

    </div>

    <div class="col-sm-1 col-xs-1 my-sizer-element"></div>
  </div>
</div>

<script is:inline type="module">
import '/plugins/shuffle.js';

var Shuffle = window.Shuffle;

class Demo {
  constructor(element) {
    this.element = element;

    this.shuffle = new Shuffle(element, {
      itemSelector: '.card-item',
      sizer: element.querySelector('.js-shuffle-sizer')
    });

    this.addShuffleEventListeners();
    this.addFilterButtons();
    this.addSorting();
    this.addSearchFilter();

    // ✅ Apply URL filter on load
    this.applyInitialFilterFromUrl();
  }

  addShuffleEventListeners() {
    this.shuffle.on(Shuffle.EventType.LAYOUT, data => {
      console.log('layout. data:', data);
    });
  }

  /* -------------------- FILTER -------------------- */

  addFilterButtons() {
    const options = document.querySelector('.filter-options');
    if (!options) return;

    const buttons = Array.from(options.children);
    buttons.forEach(button => {
      button.addEventListener('click',
        this._handleFilterClick.bind(this),
        false
      );
    });
  }

  _handleFilterClick(evt) {
    const btn = evt.currentTarget;
    const isActive = btn.classList.contains('active');
    const group = btn.getAttribute('data-group');

    this._removeActiveClassFromChildren(btn.parentNode);

    let filterGroup;

    if (isActive) {
      btn.classList.remove('active');
      filterGroup = Shuffle.ALL_ITEMS;
    } else {
      btn.classList.add('active');
      filterGroup = group;
    }

    this.shuffle.filter(filterGroup);

    // ✅ Sync URL
    const url = new URL(window.location.href);

    if (!filterGroup || filterGroup === Shuffle.ALL_ITEMS || filterGroup === "all") {
      url.searchParams.delete("group");
    } else {
      url.searchParams.set("group", filterGroup);
    }

    history.replaceState(null, "", url);
  }

  _removeActiveClassFromChildren(parent) {
    const { children } = parent;
    for (let i = children.length - 1; i >= 0; i--) {
      children[i].classList.remove('active');
    }
  }

  applyInitialFilterFromUrl() {
    const params = new URLSearchParams(window.location.search);
    const group = params.get("group");
    if (!group) return;

    const btn = document.querySelector(`.filter-item[data-group="${group}"]`);
    if (btn) btn.click();
  }

  /* -------------------- SORT -------------------- */

  addSorting() {
    const group = document.querySelector('.sort-options');
    if (!group) return;

    group.addEventListener(
      'change',
      this._handleSortChange.bind(this)
    );
  }

  _handleSortChange(evt) {
    const { value } = evt.target;

    const buttons = Array.from(evt.currentTarget.children);
    buttons.forEach(button => {
      button.classList.toggle(
        'active',
        button.querySelector('input').value === value
      );
    });

    const sortByDate = el => el.getAttribute('data-date-created');
    const sortByTitle = el => el.getAttribute('data-title').toLowerCase();

    if (value === 'date-created') {
      this.shuffle.sort({ reverse: true, by: sortByDate });
    } else if (value === 'title') {
      this.shuffle.sort({ by: sortByTitle });
    }
  }

  /* -------------------- SEARCH -------------------- */

  addSearchFilter() {
    const search = document.querySelector('.js-shuffle-search');
    if (!search) return;

    search.addEventListener(
      'keyup',
      this._handleSearchKeyup.bind(this)
    );
  }

  _handleSearchKeyup(evt) {
    const text = evt.target.value.toLowerCase();

    this.shuffle.filter((element, shuffle) => {
      if (shuffle.group !== Shuffle.ALL_ITEMS) {
        const groups = JSON.parse(
          element.getAttribute('data-groups')
        );

        if (groups.indexOf(shuffle.group) === -1) {
          return false;
        }
      }

      const title = element
        .querySelector('.card-item__title')
        .textContent
        .toLowerCase()
        .trim();

      return title.indexOf(text) !== -1;
    });
  }
}

document.addEventListener('DOMContentLoaded', () => {
  window.demo = new Demo(
    document.getElementById('js-shuffle')
  );
});
</script>
